# 🎌 日语 Anki 卡片生成器

一个功能强大的日语学习工具，使用 AI 技术自动分析日语文本，生成高质量的 Anki 学习卡片。支持单词和语法分析，提供详细的解释、例句和音调标注。

## ✨ 主要特性

### 🧠 智能分析
- **AI 驱动**：使用 Google Gemini-2.5-Flash 模型进行深度分析
- **分步处理**：先提取基本信息，再逐个详细分析，确保内容质量
- **并发处理**：支持多线程并发分析，大幅提升处理速度
- **智能重试**：自动处理 API 限制和网络错误

### 📚 学习内容
- **单词分析**：词性、释义、用法、搭配、例句、相关词汇
- **语法分析**：功能、接续、例句、相似语法区别
- **音调标注**：提供 0-4 级音调信息
- **辞书形转换**：自动将单词转换为原形

### 💾 数据管理
- **SQLite 数据库**：本地存储，支持增量更新
- **CSV 导出**：直接导入 Anki 的格式
- **批量更新**：支持更新现有卡片的词性和解析
- **ID 管理**：通过 ID 字段实现卡片更新而非重复创建

### 🎯 用户界面
- **交互式菜单**：清晰的功能选择界面
- **进度显示**：实时显示处理进度和状态
- **错误处理**：友好的错误提示和解决建议
- **配置管理**：灵活的配置文件系统

## 🚀 快速开始

### 1. 环境要求
- Rust 1.70+ 
- 网络连接（用于 API 调用）

### 2. 安装和配置

```bash
# 克隆项目
git clone <your-repo-url>
cd anki-creator

# 编译项目
cargo build --release

# 配置 API 密钥
cp config.example config.toml
# 编辑 config.toml，设置你的 OpenRouter API 密钥
```

### 3. 获取 API 密钥
1. 访问 [OpenRouter](https://openrouter.ai/)
2. 注册账号并获取 API 密钥
3. 在 `config.toml` 中设置 `openrouter_key`

### 4. 准备输入文件
将要分析的日语文本保存到 `input.txt` 文件中。

### 5. 运行程序
```bash
cargo run
```

## 📋 功能菜单

程序启动后会显示以下功能菜单：

```
🎌 日语 Anki 卡片生成器
请选择功能：
1. 解析单词        - 从文本中提取并分析单词
2. 解析语法        - 从文本中提取并分析语法点
3. 更新所有单词词性 - 重新分析数据库中所有单词的词性
4. 重新生成卡片文件 - 从数据库重新生成 Anki 导入文件
5. 更新所有单词解析 - 重新分析数据库中所有单词的详细内容
6. 根据ID更新单词解析 - 更新指定ID的单词解析
0. 退出程序
```

## 📁 项目结构

```
src/
├── lib.rs          # 库入口，导出公共接口
├── main.rs         # 主程序，用户界面和菜单系统
├── config.rs       # 配置文件处理
├── models.rs       # 数据结构定义
├── api.rs          # API 客户端和请求处理
├── database.rs     # 数据库操作和卡片生成
└── analyzer.rs     # 核心分析逻辑
```

### 模块说明

- **`config.rs`**：处理 TOML 配置文件，管理所有配置选项
- **`models.rs`**：定义数据结构，包括单词、语法、API 请求/响应等
- **`api.rs`**：OpenRouter API 客户端，处理请求重试和错误处理
- **`database.rs`**：SQLite 数据库操作，包括增删改查和 CSV 生成
- **`analyzer.rs`**：核心业务逻辑，文本分析和处理流程
- **`main.rs`**：用户界面，菜单系统和程序入口

## ⚙️ 配置说明

### config.toml 配置项

```toml
[api]
# OpenRouter API 密钥
openrouter_key = "your_api_key_here"

[processing]
# 并发处理数量（建议 10-20）
concurrent_requests = 20
# 请求间延迟（毫秒）
request_delay_ms = 100
# 最大重试次数
max_retries = 3
# 请求超时时间（秒）
request_timeout_seconds = 180

[database]
# 数据库文件名
db_file = "anki_cards.db"

[input]
# 输入文本文件路径
text_file = "input.txt"

[output]
# 输出文件名
words_file = "japanese_words.csv"
grammar_file = "japanese_grammar.csv"
```

## 📊 输出格式

### 单词卡片 (japanese_words.csv)
```csv
id,word,kana,analysis
1,"行く","いく","## 日语单词分析：行く (いく)\n\n### 1. 详细的中文解释\n「行く (いく)」是一个日语动词，表示移动、前往的意思...\n\n### 2. 词性\n**五段动词**\n\n### 3. 用法说明和语境\n常用于表示物理移动、时间流逝、事物进展等...\n\n### 4. 常见搭配和例句\n- 学校に行く (去学校)\n- 時間が行く (时间流逝)\n\n### 5. 相关词汇和变形\n- 行きます (敬语形式)\n- 行った (过去式)"
```

### 语法卡片 (japanese_grammar.csv)
```csv
id,grammar,kana,analysis
1,"ましょう","ましょう","## 日语语法分析：ましょう\n\n### 1. 语法功能\n表示邀请、建议或意志的语法形式...\n\n### 2. 接续方式\n动词ます形 + ましょう\n\n### 3. 使用场景\n- 邀请他人一起做某事\n- 表达自己的意志\n- 礼貌的建议\n\n### 4. 例句\n- 一緒に行きましょう (一起去吧)\n- 頑張りましょう (加油吧)"
```

## 🎯 在 Anki 中导入

### 导入步骤
1. 打开 Anki
2. 选择"文件" → "导入"
3. 选择生成的 CSV 文件
4. 设置字段映射：
   - 字段 1：ID（用于更新现有卡片）
   - 字段 2：正面内容（单词/语法）
   - 字段 3：读音（假名）
   - 字段 4：背面内容（详细分析）
5. 选择合适的卡组
6. 点击"导入"

### 卡组建议
- 为单词和语法创建不同的卡组
- 使用 ID 字段实现增量更新，避免重复卡片

## 🔧 高级功能

### 批量更新
- **更新词性**：重新分析所有单词的词性标注
- **更新解析**：重新生成所有单词的详细分析内容
- **增量更新**：通过 ID 字段更新特定单词

### 性能优化
- **并发处理**：支持多线程并发分析
- **智能延迟**：自动处理 API 频率限制
- **错误重试**：自动重试失败的请求
- **进度显示**：实时显示处理进度

## 📈 性能指标

### API 调用统计
- **提取阶段**：1 次 API 调用（获取所有单词和语法）
- **分析阶段**：每个条目 1 次 API 调用
- **总调用次数**：1 + 单词数量 + 语法数量

### 处理速度
- **并发处理**：20 个并发请求
- **平均速度**：约 2-3 秒/条目（包含 API 延迟）
- **大批量处理**：支持处理数千个条目

### 成本估算
基于 OpenRouter 的 Google Gemini-2.5-Flash 定价：
- 提取阶段：~3000 tokens
- 分析阶段：每个条目 ~2000 tokens
- 总成本：约 $0.01-0.05/1000 个条目

## 🛠️ 故障排除

### 常见问题

**API 密钥错误**
```
❌ 配置文件加载失败: API key not found
```
解决：检查 `config.toml` 中的 `openrouter_key` 设置

**网络连接问题**
```
❌ API 请求失败: Connection timeout
```
解决：检查网络连接，增加 `request_timeout_seconds` 值

**数据库错误**
```
❌ 数据库操作失败: Database locked
```
解决：确保没有其他程序在使用数据库文件

**文件读取错误**
```
❌ 无法读取输入文件: No such file or directory
```
解决：检查 `input.txt` 文件是否存在

### 调试技巧
1. 检查 `config.toml` 配置是否正确
2. 确认 API 密钥有效且有足够配额
3. 查看控制台输出的详细错误信息
4. 检查网络连接和防火墙设置

## 🔄 更新日志

### v0.3.0 (当前版本)
- 🆕 完全重构为模块化架构
- 🆕 添加交互式菜单系统
- 🆕 支持单词和语法分别处理
- 🆕 实现批量更新功能
- 🆕 添加并发处理支持
- 🆕 完善错误处理和用户反馈

### v0.2.0
- 🆕 实现智能分步分析流程
- 🆕 大幅提升分析质量和详细程度
- 🆕 添加 API 频率限制保护
- 🆕 完善的进度显示

### v0.1.0
- 🆕 基本的日语文本分析功能
- 🆕 SQLite 数据存储
- 🆕 Anki CSV 导出
- 🆕 OpenRouter API 集成

## 🤝 贡献指南

### 开发环境设置
```bash
# 克隆项目
git clone <repo-url>
cd anki-creator

# 安装依赖
cargo build

# 运行测试
cargo test

# 运行示例
cargo run
```

### 代码结构
- 遵循 Rust 最佳实践
- 模块化设计，职责分离
- 完善的错误处理
- 详细的文档注释

### 提交规范
- 使用清晰的提交信息
- 包含必要的测试
- 更新相关文档

## 📄 许可证

[根据需要添加许可证信息]

## 🙏 致谢

- [OpenRouter](https://openrouter.ai/) - 提供 AI API 服务
- [Google Gemini](https://ai.google.dev/) - 提供强大的语言模型
- [Anki](https://apps.ankiweb.net/) - 优秀的间隔重复学习软件
- Rust 社区 - 提供优秀的开发工具和库

---

**享受你的日语学习之旅！** 🎌✨